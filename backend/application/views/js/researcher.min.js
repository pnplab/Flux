var cct=$.cookie("csrf_cookie_aware"),device_search=null,order_by_column="device-id",order_by_type="ASC",offset=0,limit=50,selected_devices=[],visible_devices=[],total_devices,timeoutReference,currentConfig=[];
$(document).ready(function(){var c=$(".study_id").attr("id"),b=$("#study-data tr.plugin-data td.plugin-data-type").eq(0).text();$("form").submit(function(a){config=generateStudyConfiguration();$("form").append("<input type='hidden' id='config' name='config' value='"+JSON.stringify(config)+"'>")});$("#status_plugin_esm_questionnaire").parent().parent().append("<li class='sensor-setting'><a href='#' id='manage_esmq' class='disabled'>Manage questionnaires</a></li>").fadeIn("fast");$("#manage_esmq").click(function(a){a.preventDefault();
$.when(initESMQ()).done(function(){$("#esmq-questionnaires").dialog("open")})});$("#status_plugin_esm_questionnaire").change(function(a){$("#manage_esmq").toggleClass("disabled")});$("#mqtt-history-wrapper").length&&getMQTTHistory(c);0<$("table#study-devices").length&&(getDevices(),enableDeviceList());$(".table-navigation").on("click","a",function(a){a.preventDefault();$("#devices-values .success").hide();$("#devices-values .warning").hide();option=$(a.currentTarget).attr("class");"devices-next"==
option?offset+=50:"devices-previous"==option&&(offset-=50);getDevices()});$(".device-id").click(function(a){a.preventDefault();order_by_type="ASC"==order_by_type?"DESC":"ASC";order_by_column="device-id";a=$(this);getDevices();$("#study-devices .sort_arrow").remove();$('<img src="/application/views/images/'+order_by_type+'.png" height="10" width="10" style="margin-right:5px;" class="sort_arrow">').hide().prependTo(a).fadeIn(500)});$(".device-label").click(function(a){a.preventDefault();order_by_type=
"ASC"==order_by_type?"DESC":"ASC";order_by_column="device-label";a=$(this);getDevices();$("#study-devices .sort_arrow").remove();$('<img src="/application/views/images/'+order_by_type+'.png" height="10" width="10" style="margin-right:5px;" class="sort_arrow">').hide().prependTo(a).fadeIn(500)});var d;$("#devices-search").on("change paste keyup focusout",function(a){search_item=$("input#devices-search").val();timeoutReference&&clearTimeout(timeoutReference);timeoutReference=setTimeout(function(){device_search=
search_item;if("keyup"==a.type||"focusout"==a.type&&search_item!=d)offset=0,d=search_item,getDevices()},1E3)});$("div#sensors-settings-wrapper > ul#sensors-settings").length&&getStudyConfiguration();$("#mqtt-history").on("click",".mqtt-history-message",function(a){a=$(this).children(".mqtt-history-topic").text();$("tr.mqtt-history-message").css("font-weight","normal");$(this).css("font-weight","bold");$(".tab-content.value input").val("");$('.esm-message [name="esm-threshold"]').select2("val",0);
$(".esm-message input").select2("data",null);var b=$(this).children(".mqtt-history-data").text();populateMQTTMessage(a,b)});$(".plugin-data").click(function(a){$(".plugin-data").css("font-weight","normal");$(this).css("font-weight","bold");b=$(this).children(".plugin-data-type").text();$(".ui-datepicker-current-day").click()});$("#datepicker").datepicker({inline:!0,dateFormat:"yy/mm/dd",altField:"#selectedDate",minDate:new Date(1E3*$("#creation-date").text()),maxDate:0,onSelect:function(a,d){var e=
$(this).val(),f=(new Date(e)).setUTCHours(0,0,0,0),g=(new Date(e)).setUTCHours(23,59,59,999),f=f+864E5,g=g+864E5;$(".visualization-device").css("background-color","#f46d43");$(".visualization-device").hide();$("#visualization-loader.ajax-loader").show();$("table.visualization.day").remove();"esms"==b?(g=new Date,f=(new Date(g.getFullYear(),(new Date(e)).getMonth(),1)).setUTCHours(0,0,0,0)+864E5,g=(new Date(g.getFullYear(),(new Date(e)).getMonth()+1,0)).setUTCHours(23,59,59,999)+864E5,$.ajax({url:"../get_visualization_data_esms",
type:"POST",data:{study_id:c,devices_list:visible_devices,start:f,end:g,table:b,csrf_token_aware:cct},dataType:"json",success:function(a){$("div#visualization-devices").before(a);$(".visualization.day.device").bind("click",function(){id=$(this).attr("title");var a=$("#cb_"+id).prop("checked"),a=0==a?!0:!1;$("#cb_"+id).prop("checked",a)});$("#visualization-loader.ajax-loader").hide();enableDeviceList()},error:function(a){enableDeviceList()}})):$.ajax({url:"../get_visualization_data",type:"POST",data:{study_id:c,
devices_list:visible_devices,start:f,end:g,table:b,csrf_token_aware:cct},dataType:"json",success:function(a){for(i=0;i<a.length;i++)$("#viz_"+a[i].device_id).css("background-color","#a6d96a");$(".visualization-device").show();$("#visualization-loader.ajax-loader").hide();enableDeviceList()},error:function(a){enableDeviceList()}})}});b=$("#study-data tr.plugin-data td.plugin-data-type").eq(0).text();$(".sendbutton").prop("disabled",!0);$("#select-all").click(function(){$("#devices-values .success").hide();
$("#devices-values .warning").hide();var a=this.checked;$(":checkbox").prop("checked",a);if(a){for(a=0;a<visible_devices.length;a++)-1==selected_devices.indexOf(visible_devices[a])&&selected_devices.push(visible_devices[a]);a="<div class='success'>"+visible_devices.length+" devices on this view selected.";a=0<total_devices-selected_devices.length?a+"<a href='#' class='select-rest'>Select rest "+(total_devices-selected_devices.length)+" devices</a>":a+"</div>";$("#devices-values").prepend($(a).hide().fadeIn("medium"));
$(".select-rest").bind("click",function(a){a.preventDefault();selected_devices=[];var b;$("#devices-loader.ajax-loader").show();disableDeviceList();$.ajax({url:"../get_study_devices_all",type:"POST",data:{study_id:$(".study_id").attr("id"),device_search:device_search,csrf_token_aware:cct},dataType:"json",success:function(a){b=a.total;for(var d=0;d<Object.keys(a).length-1;d++)selected_devices.push(a[d].device_id);$("#devices-values .success").hide();a="<div class='success'>All "+b+" devices matching active filters selected!</div>";
$("#devices-values").prepend($(a).hide().fadeIn("medium"));$("#devices-loader.ajax-loader").hide();enableDeviceList()},error:function(a){enableDeviceList()}})});$(".sendbutton").prop("disabled",!1)}else{for(a=0;a<visible_devices.length;a++)selected_devices.splice($.inArray(visible_devices[a],selected_devices),1);a="<div class='warning'>"+visible_devices.length+" devices on this view deselected.";a=0<selected_devices.length?a+"<a href='#' class='deselect-rest'>Deselect rest "+selected_devices.length+
" devices</a>":a+"</div>";$("#devices-values").prepend($(a).hide().fadeIn("medium"));$(".deselect-rest").bind("click",function(a){a.preventDefault();$("#devices-values .warning").hide();a="<div class='warning'>All "+selected_devices.length+" devices matching active filters deselected!</div>";$("#devices-values").prepend($(a).hide().fadeIn("medium"));selected_devices=[];$("#devices-loader.ajax-loader").hide()});$(".sendbutton").prop("disabled",!0)}$(".devices-count").html(selected_devices.length)});
$(".sendbutton").click(function(a){a.preventDefault();var b=$("div.tabs ul li.selected a").attr("id").split("-")[1],d;d="esm"==b?$("#esm-"+$("#esm-type").val()):$("form#"+b);"custom"==b&&(b=$("input[name=custom-topic]").val());$(".error-msg").remove();$(".mqtt-error").remove();if(0<$("#esm-queue > tbody > tr").length){var e=[];$("#esm-queue tbody td.esm-queue-message-data").each(function(){e.push($(this).text().substring(1,$(this).text().length-1))});a="["+e.join(",")+"]";sendMQTTMessage("esm",a,
c)}else a=d.serialize(),$.ajax({url:"../../webservice/construct_mqtt_message",type:"POST",data:{form_data:a,csrf_token_aware:cct},dataType:"json",success:function(a){a.error?($.each(a.errors,function(a,b){$("#"+d.attr("id")+" input[name='"+a+"']").after("<span class='error-msg'>*</span>")}),$("#"+b+" div.buttons").before("<div class='mqtt-error'>Please fill all the fields</div>")):sendMQTTMessage(b,a,c)},error:function(a){}})});$("#add-to-queue").click(function(a){a.preventDefault();var b=$("#esm-"+
$("#esm-type").val());$(".error-msg").remove();$(".mqtt-error").remove();a=b.serialize();$.ajax({url:"../../webservice/construct_mqtt_message",type:"POST",data:{form_data:a,csrf_token_aware:cct},dataType:"json",success:function(a){if(a.error)$.each(a.errors,function(a,d){$("#"+b.attr("id")+" input[name='"+a+"']").after("<span class='error-msg'>*</span>")}),$("#esm div.buttons").before("<div class='mqtt-error'>Please fill all the fields</div>");else{var d=jQuery.parseJSON(a)[0],c=d.esm.esm_type,d=
d.esm.esm_title;$("table#esm-queue tbody").append("<tr class='esm-queue-message'><td class='esm-queue-message-type'>"+{1:"Free text",2:"Radio",3:"Checkbox",4:"Likert",5:"Quick answer"}[c]+"</td><td class='esm-queue-message-title' title='"+d+"'>"+d+"</td><td class='esm-queue-message-data'>"+a+"</td><td class='esm-queue-message-remove'><img src='/application/views/images/delete_icon.png' alt='Remove' height='11' width='11' class='del_image'></td></tr>");$(".esm-queue-message-remove").bind("click",function(){$(this).parent().remove()});
$(".tab-content.value input").val("");$('.esm-message [name="esm-threshold"]').select2("val",0);$(".esm-message input").select2("data",null)}}})});$("#esm-queue").on("click",".esm-queue-message> td:nth-child(1), .esm-queue-message> td:nth-child(2)",function(a){a=$(this).parent().children(".esm-queue-message-data").text();populateMQTTMessage("esm",a)});$("#esm-queue thead").append("<tr class='no-data'><td colspan='2'>Your ESM queue is empty.</td></tr>");$("#esm-queue-title").hide();$("table#esm-queue tbody").bind("pageinit DOMSubtreeModified",
function(){0<$("#esm-queue > tbody > tr").length?($("#esm-queue thead tr.no-data").hide(),$("#esm-queue-title").show()):($("#esm-queue-title").hide(),$("#esm-queue thead").append("<tr class='no-data'><td colspan='2'>Your ESM queue is empty</td></tr>"))});$(".more-link").click(function(a){a.preventDefault()});$(".less-link").click(function(a){a.preventDefault()});$(".db_selection").change(function(){"My own"==$(this).val()?$(".newstudy_hiddenstuff").show():$(".newstudy_hiddenstuff").hide()});$("#study-data tr.plugin-data").eq(0).css("font-weight",
"bold");$("#close-study-dialog").dialog({width:"auto",height:"auto",autoOpen:!1,modal:!0,draggable:!1,resizable:!1,buttons:{"Close study":function(){var a=$(".study_id").attr("id");changeStudyStatus(a,0);$("#close-study-dialog").dialog("close")},Cancel:function(){$("#close-study-dialog").dialog("close")}}});$(".study-status").click(function(a){a=$(this).is(":checked")?!0:!1;var b=$(".study_id").attr("id");0==a?($("#close-confirm").prop("checked",!0),$("#close-study-dialog").dialog("open")):changeStudyStatus(b,
1)});var e="",f=0;$("#description-buttons .save-cancel").hide();$("#description-buttons .edit-description").click(function(a){a.preventDefault();e=$("#expand_area").val();f=$("#expand_area")[0].scrollHeight-8;$("textarea#expand_area").attr("disabled",!1).focus();$("#description-buttons .save-cancel").show()});$("#description-buttons .cancel-button").click(function(a){a.preventDefault();$("textarea#expand_area").attr("disabled",!0);$("#description-buttons .save-cancel").hide();$("#expand_area").val(e);
$("#expand_area").height(f)});$("#description-buttons .save-button").click(function(a){a.preventDefault();$("textarea#expand_area").attr("disabled",!0);a=$(".study_id").attr("id");var b=$("textarea#expand_area").val(),d=$("textarea#expand_area");$.ajax({url:"../edit_description",type:"POST",data:{study_id:a,description:b,csrf_token_aware:cct},dataType:"json",success:function(a){0!=a?(d.val(a),$("#description-buttons .save-cancel").hide(),e=$("#expand_area").val(),f=$("#expand_area")[0].scrollHeight):
($("#expand_area").val(e),$("#expand_area").height(f))}})});$("#sensors-buttons .save-cancel").hide();$("#sensors-buttons .edit-description").click(function(a){a.preventDefault();currentConfig=generateStudyConfiguration();$("#sensors-settings").removeClass("disabled");$("ul#sensors-settings li.sensor").fadeIn("medium");$("ul#sensors-settings input").prop("disabled",!1);$("#sensors-buttons .save-cancel").show();$(".sensor-arrow").removeClass("disabled");$("dConfiv.no-data.sensors").remove();$("#sensors-settings-wrapper").children(".no-data").remove();
$("#status_plugin_esm_questionnaire").prop("checked")&&$("#manage_esmq").toggleClass("disabled")});$("#sensors-buttons .cancel-button").click(function(a){a.preventDefault();getStudyConfiguration();$("#sensors-buttons .save-cancel").hide();$("#manage_esmq").toggleClass("disabled")});$("#sensors-buttons .save-button").click(function(a){a.preventDefault();a=generateStudyConfiguration();$.ajax({async:!1,url:"../update_study_sensors",type:"POST",data:{study_id:c,config:JSON.stringify(a),csrf_token_aware:cct},
dataType:"json"});$.ajax({async:!1,url:"../../webservice/study_config_updated",type:"POST",data:{study_id:c,config:JSON.stringify(a),csrf_token_aware:cct},dataType:"json"});$("#sensors-buttons .save-cancel").hide();$("#manage_esmq").toggleClass("disabled");getStudyConfiguration()});$(".delete-co").each(function(){$.data(this,"dialog",$(this).next(".delete-dialog").dialog({autoOpen:!1,modal:!0,draggable:!1,resizable:!1}))}).click(function(a){a.preventDefault();a=$(this).parent().attr("id");var b=$(".study_id").attr("id");
a={user_id:a,study_id:b,csrf_token_aware:cct};$.data(this,"dialog").dialog("option","title","Delete co-researcher");$.data(this,"dialog").dialog({buttons:getButtonsDelCo("../delete_co",a)});$.data(this,"dialog").dialog("open")});$("#delete-study-dialog").dialog({width:"auto",height:"auto",autoOpen:!1,modal:!0,draggable:!1,resizable:!1,buttons:{"Delete study":function(){$.ajax({url:"../delete_study",type:"POST",data:{study_id:c,csrf_token_aware:cct},dataType:"json",success:function(a){1==a&&window.location.replace("../studies")}})},
Cancel:function(){$(this).dialog("close")}}});$("#delete-study").click(function(a){$("#delete-study-dialog").dialog("open")});$(".qr_dialog").dialog({width:"auto",height:"auto",autoOpen:!1,modal:!0,draggable:!1,resizable:!1,buttons:{Download:function(){$(this).dialog("close")},Close:function(){$(this).dialog("close")}}});$(".show_qr").click(function(a){a.preventDefault();$(".qr_dialog").dialog("open")});$('button span:contains("Download")').parent().wrap('<a href="#" id="submit_qr_wrapper"></a>');
$("#submit_qr, #submit_qr_wrapper").click(function(a){a.preventDefault();$("#qr_form").submit();return!1});$(".add-co").each(function(){$.data(this,"dialog",$(this).next(".add-dialog").dialog({autoOpen:!1,modal:!0,draggable:!1,resizable:!1}))}).click(function(a){a.preventDefault();a=$(".study_id").attr("id");$.data(this,"dialog").dialog("option","title","Add co-researcher");$.data(this,"dialog").dialog({buttons:getButtonsAddCo("../add_co",a)});$.data(this,"dialog").dialog("open")});$("#show-db-credentials").click(function(a){a.preventDefault();
$("#study-data-dialog").dialog("open")});$("#study-data-dialog").dialog({width:"auto",height:"auto",autoOpen:!1,modal:!0,draggable:!1,resizable:!1,buttons:{Close:function(){$(this).dialog("close")}}});$("#newstudy_testbutton").click(function(a){a.preventDefault();$("#connection-error").hide();$("#connection-success").hide();a=$("#db_hostname").val();var b=$("#db_port").val(),d=$("#db_name").val(),c=$("#db_username").val(),e=$("#db_password").val();$.ajax({url:"../webservice/check_database_connection",
type:"POST",data:{hostname:a,port:b,db_name:d,username:c,password:e,csrf_token_aware:cct},dataType:"json",success:function(a){1==a?$("#connection-success").show():0==a&&$("#connection-error").show()}})});$(".error-state").delay(1E4).fadeOut("slow")});
function getButtonsDelCo(c,b){return{Ok:{text:"Ok",click:function(){$.ajax({url:c,type:"POST",data:b,dataType:"json",success:function(b){window.location.reload(!0)},error:function(b){window.location.reload(!0)}})},"class":"button-dialog-ok"},Cancel:{text:"Cancel",click:function(){$("#email").val("");$(".dialog-error").hide();$(this).dialog("close")},"class":"button-dialog-close"}}}
function getButtonsDelStudy(c,b){return{Ok:{text:"Ok",click:function(){$.ajax({url:c,type:"POST",data:b,dataType:"json",success:function(b){window.location.reload(!0)},error:function(b){window.location.reload(!0)}})},"class":"button-dialog-ok"},Cancel:{text:"Cancel",click:function(){$("#email").val("");$(".dialog-error").hide();$(this).dialog("close")},"class":"button-dialog-close"}}}
function getButtonsAddCo(c,b){return{Ok:{text:"Ok",click:function(){var d=$("#email").val();$.ajax({url:c,type:"POST",data:{email:d,study_id:b,csrf_token_aware:cct},dataType:"json",success:function(b){0==b?$(".dialog-error").toggle():($(".dialog-error").hide(),window.location.reload(!0))},error:function(b){window.location.reload(!0)}})},"class":"button-dialog-ok"},Cancel:{text:"Cancel",click:function(){$("#email").val("");$(".dialog-error").hide();$(this).dialog("close")},"class":"button-dialog-close"}}}
function setMQTT(){$(".mqtt-id").each(function(){for(var c=$(this).closest("td").prev("td").text(),b=0,d=0;d<c.length;d++)b=(b<<5)-b+c.charCodeAt(d),b&=b;$(this).text(b)})}
function getMQTTHistory(c){$("#mqtt-history > tbody > tr").remove();$.ajax({url:"../get_mqtt_history",type:"POST",data:{study_id:c,csrf_token_aware:cct},dataType:"json",success:function(b){if($.isEmptyObject(b))$("#mqtt-history-wrapper").parent().append("No MQTT messages sent"),$("#mqtt-history-wrapper").hide();else for(var d in b){var c=new Date(1E3*b[d].timestamp),c=new Date(c.setHours(c.getHours()+c.getTimezoneOffset()/60));date_long=$.formatDateTime("d MM yy hh:ii",c);var c=$.formatDateTime("d MM yy",
c),f=b[d].topic;if("esm"==b[d].topic)for(var a=jQuery.parseJSON(b[d].message),h=0;h<a.length;h++){var k=a[h].esm.esm_title;$("#mqtt-history tbody").append("<tr class='mqtt-history-message'><td class='mqtt-history-date'>"+c+"</td><td class='mqtt-history-topic'>"+f+"</td><td class='mqtt-history-title' title='"+date_long+" "+k+"'>"+k+"</td><td class='mqtt-history-data' style='display: none;'>["+JSON.stringify(a[h])+"]</td><td class='mqtt-history-devices' style='display: none;'>"+b[d].receivers+"</td></tr>")}else $("#mqtt-history tbody").append("<tr class='mqtt-history-message'><td class='mqtt-history-date'>"+
c+"</td><td class='mqtt-history-topic'>"+f+"</td><td class='mqtt-history-title'>"+b[d].message+"</td><td class='mqtt-history-data' style='display: none;'>"+b[d].message+"</td><td class='mqtt-history-devices' style='display: none;'>"+b[d].receivers+"</td></tr>");$("#mqtt-history").trigger("update")}}})}
function updateDeviceLabels(){var c={study_id:$(".study_id").attr("id"),device_id_list:visible_devices,csrf_token_aware:cct};$.ajax({url:"../get_device_data",type:"POST",data:c,dataType:"json",success:function(b){$("#study-devices tr.device-row").each(function(d,c){var f=$.grep(b,function(a){return a.device_id==$(c).find("td.device-id").text()});1==f.length&&$(c).find("td.device-label input").val(f[0].label)})},error:function(b){}})}
function getDevices(){var c=[],b=[];visible_devices=[];$("#devices-loader.ajax-loader").show();disableDeviceList();$.ajax({url:"../get_study_devices",type:"POST",data:{study_id:$(".study_id").attr("id"),device_search:device_search,order_by_column:order_by_column,order_by_type:order_by_type,offset:offset,limit:limit,csrf_token_aware:cct},dataType:"json",success:function(d){total_devices=d[d.length-1].total;b.push('<div id="visualization-loader" class="ajax-loader"></div>');for(var e=0;e<Object.keys(d).length-
1;e++)c.push('<tr id="'+d[e].device_id+'" class="device-row"><td class="checkbox-cell"><input type="checkbox" class="select-device basic" name="devices[]" value="1" id="cb_'+d[e].device_id+'"><label for="cb_'+d[e].device_id+'" style="margin-top: -9px !important;"></label></td><td class="device-id">'+d[e].device_id+'</td><td class="device-label"><input type="text" class="label_box" readonly value="'+(null==d[e].label?"":d[e].label)+'"><div class="label-buttons"><a href="#" class="edit-description"><img src="/application/views/images/edit.png" alt="Edit" height="11" width="11" class="edit_image"></a><a href="#" class="cancel-button save_cancel"><img src="/application/views/images/delete_icon.png" alt="Cancel" height="11" width="11" class="del_image"></a><a href="#" class="save-button save_cancel"><img src="/application/views/images/ok.png" alt="Save" height="13" width="13" class="ok_image"></a></div></td></tr>'),
visible_devices.push(d[e].device_id),b.push('<div class="visualization-device" title="'+(""==d[e].label?d[e].device_id:d[e].label)+'" id="viz_'+d[e].device_id+'"></div>');$("#study-devices tbody").html(c);$("#visualization-devices").html(b);bindLabelButtons();$(".table-navigation").empty();$(".table-navigation").append('<div class="table-info">Displaying '+(0==d[d.length-1].total?"0":offset+1+"-"+(offset+Object.keys(d).length-1))+" of total "+d[d.length-1].total+' devices. Total of <span class="devices-count">'+
selected_devices.length+"</span> devices selected.</div>");1<offset&&$(".table-navigation").append("<a href='#' class='devices-previous'>&laquo; Previous</a>");offset+Object.keys(d).length-1<d[d.length-1].total&&$(".table-navigation").append("<a href='#' class='devices-next'>Next &raquo;</a>");$("input.select-device").bind("click",function(){var b=$(this).attr("id").split("cb_")[1];$(this).prop("checked")?selected_devices.push(b):selected_devices.splice($.inArray(b,selected_devices),1);$(".devices-count").html(selected_devices.length);
for(b=0;b<visible_devices.length;b++){if(-1==selected_devices.indexOf(visible_devices[b])){$("#select-all:checkbox").prop("checked",!1);$("#devices-values .success").hide();break}if(b==visible_devices.length-1){$("#select-all:checkbox").prop("checked","checked");var a="<div class='success'>"+visible_devices.length+" devices on this view selected.",a=0<total_devices-selected_devices.length?a+"<a href='#' class='select-rest'>Select rest "+(total_devices-selected_devices.length)+" devices</a>":a+"</div>";
$("#devices-values").prepend($(a).hide().fadeIn("medium"))}}0<selected_devices.length?$(".sendbutton").prop("disabled",!1):$(".sendbutton").prop("disabled",!0)});for(e=0;e<visible_devices.length;e++)-1<$.inArray(visible_devices[e],selected_devices)&&$("#cb_"+visible_devices[e]).prop("checked","checked");$(".select-device:checked").length!=visible_devices.length&&$("#select-all:checkbox").prop("checked",!1);$(".visualization-device").bind("click",function(){id=$(this).attr("id").split("viz_")[1];var b=
$("#cb_"+id).prop("checked"),b=0==b?!0:!1;$("#cb_"+id).prop("checked",b)});$("#devices-loader.ajax-loader").hide();0<total_devices?($("#select-all").prop("disabled",!1),$("#study-data tr.plugin-data td.plugin-data-type").eq(0).text(),$(".ui-datepicker-current-day").click()):(enableDeviceList(),$("#select-all").prop("disabled",!0))},error:function(b){console.log(b)}})}
function bindLabelButtons(){$(".label-buttons .save_cancel").hide();$(function(){$(".label-buttons .edit-description").click(function(c){var b=$(this).parents().eq(2).find(".select-device");c.preventDefault();b.is(":checked")||b.click();$(".select-device").each(function(b,d){$(this).attr("disabled",!0)});$("#select-all").attr("disabled",!0);$(".label-buttons").children(".save_cancel").hide();$(".device-label input").attr("readonly",!0);$(this).parents().eq(1).children("input").attr("readonly",!1).focus();
var d=$(this).parents().eq(1).children(".label-buttons");$(".edit-description").fadeOut(500,function(){d.children(".save_cancel").fadeIn(500)})})});$(".label-buttons .cancel-button").click(function(c){c.preventDefault();$(this).parents().eq(1).children("input").attr("readonly",!0);$(this).parents().eq(1).children(".label-buttons").children(".save_cancel").fadeOut(500,function(){$(".edit-description").fadeIn(500)});$(".select-device").each(function(b,d){$(this).attr("disabled",!1)});$("#select-all").attr("disabled",
!1);updateDeviceLabels()});$(".label-buttons .save-button").click(function(c){c.preventDefault();$(this).parents().eq(1).children("input").attr("readonly",!0);c=$(this).parents().eq(1).children("input").val();$(this).parents().eq(1).children("input");c={study_id:$(".study_id").attr("id"),device_id_list:selected_devices,label:c,csrf_token_aware:cct};$.ajax({url:"../edit_label",type:"POST",data:c,dataType:"json",success:function(b){updateDeviceLabels()},error:function(b){}});$(this).parents().eq(1).children(".label-buttons").children(".save_cancel").fadeOut(500,
function(){$(".edit-description").fadeIn(500)});$(".select-device").each(function(b,d){$(this).attr("disabled",!1)});$("#select-all").attr("disabled",!1)});$("td.device-label input").bind("change paste keyup",function(){var c=$(this).val();$("#study-devices tr.device-row").each(function(b,d){$(d).find("td.checkbox-cell input").is(":checked")&&$(d).find("td.device-label input").val()!=c&&$(d).find("td.device-label input").val(c)})})}
function disableDeviceList(){$("#devices-values").addClass("disable_elements");$("#devices-values").fadeTo(100,.6);$("#devices-values").children().prop("disabled",!0)}function enableDeviceList(){$("#devices-values").fadeTo("medium",1);$("#devices-values").removeClass("disable_elements");$("#devices-values").children().prop("disabled",!1)}
function populateMQTTMessage(c,b){if("esm"==c){$("a#tab-esm").click();b=jQuery.parseJSON(b)[0].esm;var d=b.esm_type;$("#esm-type").select2("val",d);$(".esm-message").hide();$("."+d).fadeIn("medium");switch(d){case "1":$('.esm-message.1 [name="esm-title"]').val(b.esm_title);$('.esm-message.1 [name="esm-instructions"]').val(b.esm_instructions);$('.esm-message.1 [name="esm-threshold"]').select2("val",b.esm_expiration_threashold);break;case "2":$('.esm-message.2 [name="esm-title"]').val(b.esm_title);
$('.esm-message.2 [name="esm-instructions"]').val(b.esm_instructions);$('.esm-message.2 [name="esm-options"]').select2("val",b.esm_radios);$('.esm-message.2 [name="esm-threshold"]').select2("val",b.esm_expiration_threashold);break;case "3":$('.esm-message.3 [name="esm-title"]').val(b.esm_title);$('.esm-message.3 [name="esm-instructions"]').val(b.esm_instructions);$('.esm-message.3 [name="esm-options"]').select2("val",b.esm_checkboxes);$('.esm-message.3 [name="esm-threshold"]').select2("val",b.esm_expiration_threashold);
break;case "4":$('.esm-message.4 [name="esm-title"]').val(b.esm_title);$('.esm-message.4 [name="esm-instructions"]').val(b.esm_instructions);$('.esm-message.4 [name="esm-likertmax"]').select2("val",b.esm_likert_max);$('.esm-message.4 [name="esm-likertmax-label"]').val(b.esm_likert_max_label);$('.esm-message.4 [name="esm-likertmin-label"]').val(b.esm_likert_min_label);$('.esm-message.4 [name="esm-threshold"]').select2("val",b.esm_expiration_threashold);break;case "5":$('.esm-message.5 [name="esm-title"]').val(b.esm_title),
$('.esm-message.5 [name="esm-instructions"]').val(b.esm_instructions),$('.esm-message.5 [name="esm-options"]').select2("val",b.esm_quick_answers),$('.esm-message.5 [name="esm-threshold"]').select2("val",b.esm_expiration_threashold)}}else if("broadcasts"==c)$("a#tab-broadcasts").click(),$('div#broadcasts [name="broadcasts-type"]').select2("val",b);else if("configuration"==c){$("a#tab-configuration").click();var d=$.parseJSON(b),e=[];$(d).each(function(b,a){e.push(a.setting+"="+a.value)});e=e.filter(function(b){return b});
$('#configuration [name="configuration"]').select2("val",e)}else $("a#tab-custom").click(),$('.tab-content.value [name="custom-topic"]').val(c),$('.tab-content.value [name="custom-description"]').val(b)}
function sendMQTTMessage(c,b,d){$.ajax({url:"../../webservice/publish",type:"POST",data:{study_id:d,devices_list:selected_devices,mqtt_type:c,msg:b,csrf_token_aware:cct},dataType:"json",success:function(b){b.errors||(b=$("div.tabs ul li.selected a").attr("id").split("-")[1],$("#"+b+" div.buttons").before("<div class='success-msg'>MQTT message(s) pushed to all selected devices</div>"),$(".success-msg").delay(5E3).fadeOut("medium",function(){this.remove()}),$("#esm-queue > tbody > tr").remove(),getMQTTHistory(d))},
error:function(b){}})}function getBase64FromImageUrl(c){var b=new Image;b.src=c;b.onload=function(){var b=document.createElement("canvas");b.width=this.width;b.height=this.height;b.getContext("2d").drawImage(this,0,0);b=b.toDataURL("image/png");alert(b.replace(/^data:image\/(png|jpg);base64,/,""))}}
function getStudyConfiguration(){$("ul#sensors-settings").find("*").removeClass("enabled");$("ul#sensors-settings").find("*").removeClass("active");$("ul#sensors-settings input").prop("disabled",!0);$("ul#sensors-settings input[type=checkbox]").prop("checked",!1);$("ul#sensors-settings input[type=text]").val("");$("ul#sensors-settings").addClass("disabled");$("ul#sensors-settings li.sensor").hide();$("ul.sensor-settings").hide();$("div.sensor-arrow").removeClass("down").addClass("up");$(".sensor-arrow").addClass("disabled");
$(".sensor-value").removeClass("enabled");$.ajax({dataType:"json",data:{csrf_token_aware:cct},url:"../get_study_configuration/"+$(".study_id").attr("id"),type:"POST",success:function(c){if(0<c.length){c=$.parseJSON(c[0].text);var b=[];"undefined"!==typeof c.sensors&&(b=b.concat(c.sensors));for(p in c.plugins)for(s in c.plugins[p].settings)b.push(c.plugins[p].settings[s]);"undefined"!==typeof b[0]?$(b).each(function(b,c){var f=c.setting,a=c.value;"object"===typeof a&&(a=JSON.stringify(a));"true"==
a?$("#"+f).prop("checked",!0):$("#"+f).val(a);$("#"+f).addClass("enabled");$("#"+f).parent().parent().parent().show();$("#"+f).parent().parent().parent().addClass("active");$("#"+f).parent().parent().parent().addClass("enabled");$("#"+f).parent().parent().show();$("#"+f).parent().show();$("#"+f).parent().parent().parent().children(".sensor-arrow").removeClass("up").addClass("down")}):$("#sensors-settings-wrapper").prepend('<div class="no-data">There\'s no enabled sensors or plugins for this study.</div>')}else $("#sensors-settings-wrapper").prepend("<div class='no-data sensors'>This study doesn't use any sensors.</div>")}})}
function generateStudyConfiguration(){var c={};$("li.sensor").each(function(){for(var b=$(this),d=b.find("input.value"),e={},f=0;f<Object(d).length;f++){var a=$(d[f]);if(a.prop("checked")&&a.hasClass("boolean"))if(b.children("p.label").hasClass("plugin")){var h=b.children("input.package-name").val();e.plugin=h;e.settings=[{setting:a.attr("id"),value:"true"}]}else void 0==c.sensors&&(c.sensors=[]),c.sensors.push({setting:a.attr("id"),value:"true"});else a.hasClass("enabled")&&(a.hasClass("integer")||
a.hasClass("text")||a.hasClass("real"))&&(b.children("p.label").hasClass("plugin")?"undefined"!==typeof e.settings&&e.settings.push({setting:a.attr("id"),value:a.val()}):"undefined"!==typeof c.sensors&&c.sensors.push({setting:a.attr("id"),value:a.val()}))}void 0!=e.plugin&&(void 0==c.plugins&&(c.plugins=[]),c.plugins.push(e))});return c}
function changeStudyStatus(c,b){$.ajax({url:"../../webservice/update_study_status",type:"POST",data:{study_id:c,value:b,csrf_token_aware:cct},dataType:"json",success:function(c){$("input#close-confirm").prop("checked",Boolean(b));$("span.toggle-status").toggleClass("active")}})}
function getConfigDifference(c,b){var d=[];for(i=0;i<c.length;i++)for(j=0;j<b.length&&b[j].setting!=c[i].setting;j++)j==b.length-1&&"setting"in c[i]&&-1<c[i].setting.indexOf("status_")&&d.push({setting:c[i].setting,value:"false"});return d};
