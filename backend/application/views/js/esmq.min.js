function initESMQ(){$("#content").append("<div id='esmq-questionnaires' style='display: none;'> <ul> <li><a href='#esmq-0' id='add-new'>Add new</a></li> </ul> </div>");$("#esmq-questionnaires").tabs().dialog({autoOpen:!1,modal:!0,width:800,minHeight:500,draggable:!1,buttons:{Save:function(){var a=$(".input-field");a.removeClass("invalid");$(".esmq-weekday").removeClass("invalid");for(var h=!0,d=-1,e=0;e<a.length;e++)0==$(a[e]).val().length&&($(a[e]).addClass("invalid"),h=!1,d=$(a[e]).closest(".esm-questionnaire").attr("id").split("esm-questionnaire")[1]);
a=$(".esm-questionnaire-item.value.weekdays");for(e=0;e<a.length;e++)0==$(a[e]).children(".esmq-weekday").children("input:checked").length&&($(a[e]).children(".esmq-weekday").addClass("invalid"),h=!1,d=$(a[e]).closest(".esm-questionnaire").attr("id").split("esm-questionnaire")[1]);h?($("#questionnaires_plugin_esm_questionnaire").val(getESMQConfig($(this))),$("#questionnaires_plugin_esm_questionnaire").addClass("enabled"),$(this).dialog("destroy").remove(),$("#sensors-buttons .save-button").click()):
$("#esmq-questionnaires").tabs({active:d})},Cancel:function(){$(this).dialog("destroy").remove();$("#sensors-buttons .cancel-button").click()}},create:function(){function a(e){$(".esmq-info").remove();var b="Questionnaire "+h,a="esmq-"+h,b=$("<li><a href='#{href}'>#{label}</a> <span class='ui-icon ui-icon-close' role='presentation'>Remove Tab</span></li>".replace(/#\{href\}/g,"#"+a).replace(/#\{label\}/g,b));d.find(".ui-tabs-nav").append(b);d.append("<div id='"+a+"'>"+e.replace(/{count}/g,h)+"</div>");
d.tabs("refresh");d.tabs({active:h});$("#esmq"+h+"-startdate").datepicker({dateFormat:"yy-mm-dd",minDate:new Date,onSelect:function(b){var a=this.id.split("-")[0];$("#"+a+"-enddate").datepicker("option","minDate",new Date(b))}});$("#esmq"+h+"-enddate").datepicker({dateFormat:"yy-mm-dd",minDate:new Date,onSelect:function(b){var a=this.id.split("-")[0];$("#"+a+"-startdate").datepicker("option","maxDate",new Date(b))}});$("#esmq"+h+"-starttime").timepicker();$("#esmq"+h+"-endtime").timepicker();$("#esmq"+
h+"-amount").slider({value:1,min:1,max:10,step:1}).each(function(){for(var b=$(this).data().uiSlider.options,b=b.max-b.min,a=0;a<=b;a++){var e=$("<label>"+(a+1)+"</label>").css("left",a/b*100+"%");$("#esmq"+h+"-amount").append(e)}});$(".input-field.esmq-amount").numeric();$("#esm-questionnaire"+h).on("click",".esmq-option-add",function(b){b.preventDefault();var a=$(this).closest(".esmq-question").find(".esmq-question-id").val(),e=$(this).closest(".esm-questionnaire").find(".esmq-question-id").map(function(){if(this.value!=
a)return"<option value='"+this.value+"'>"+this.value+"</option>"}).get().join(""),d=$(this).parent().parent().children(".esm-questionnaire-item.value").children("select.esmq-question-type").val(),f=$(this).parent().find(".esmq-option").length+1;b=$(this).parent();e=3==d?'<div class="esmq-option"><div class="esmq-option-del"><a href="#">-</a></div><div class="esmq-option-value long"><input type="text" placeholder="Option" class="input-field"></div></div>':'<div class="esmq-option"><div class="esmq-option-del"><a href="#">-</a></div><div class="esmq-option-value"><input type="text" placeholder="Option" class="input-field"></div><div class="esmq-option-followup" id="fup_'+
(h-1)+"-"+parseInt(a)+"-"+f+'"><select class="esmq-followup" type="hidden"><option value="false">End</option>'+e+"</select></div></div>";b.children(".esmq-option-add").before($(e).fadeIn("fast"))});$("#esm-questionnaire"+h).on("click",".esmq-option-del",function(b){b.preventDefault();b=$(this).parent();1<b.parent().children(".esmq-option").length&&b.remove().fadeOut("fast")});$("#esm-questionnaire"+h).closest(".esm-questionnaire").find("select.esmq-question-type").on("change",function(){var b=$(this).closest(".esmq-question").find(".esmq-question-id").val(),
a=$(this).closest(".esm-questionnaire").find(".esmq-question-id").map(function(){if(this.value!=b)return"<option value='"+this.value+"'>"+this.value+"</option>"}).get().join(""),e=$(this).val();$(this).parent().parent().children(".esmq-options");var d=$(this).parent().parent();d.children(".esmq-options").remove();d.children(".esm-questionnaire-item.extra").remove();1==e?d.append($('<div class="esm-questionnaire-item option extra">Follow up</div><div class="esm-questionnaire-item value extra"> <select class="esmq-followup"><option value="false">End</option>'+
a+"</select> </div>").hide().fadeIn("fast")):2==e?d.append($('<div class="esmq-options"> <div class="esmq-legends"> <span style="margin-left: 12px">Choice</span> <span style="margin-left: 115px">To question #</span> </div> <div class="esmq-option"> <div class="esmq-option-del"> <a href="#">-</a> </div> <div class="esmq-option-value"> <input type="text" placeholder="Option" class="input-field"> </div> <div class="esmq-option-followup"> <select class="esmq-followup"><option value="false">End</option>'+
a+'</select> </div> </div> <div class="esmq-option-add"> <a href="#">+</a> </div> </div>').hide().fadeIn("fast")):3==e?(d.append($('<div class="esm-questionnaire-item option extra">Follow up</div><div class="esm-questionnaire-item value extra"> <select class="esmq-followup"><option value="false">End</option>'+a+"</select> </div>").hide().fadeIn("fast")),d.append($('<div class="esmq-options"> <div class="esmq-legends"> <span style="margin-left: 12px">Choice</span> </div> <div class="esmq-option"> <div class="esmq-option-del"> <a href="#">-</a> </div> <div class="esmq-option-value long"> <input type="text" placeholder="Option" class="input-field"> </div> </div> <div class="esmq-option-add"> <a href="#">+</a> </div> </div>').hide().fadeIn("fast"))):
4==e?d.append($('<div class="esm-questionnaire-item option extra"> Max label </div> <div class="esm-questionnaire-item value extra"> <input type="text" class="input-field likert-max-label"> </div> <div class="esm-questionnaire-item option extra"> Min label </div> <div class="esm-questionnaire-item value extra"> <input type="text" class="input-field likert-min-label"> </div><div class="esm-questionnaire-item option extra">Follow up</div><div class="esm-questionnaire-item value extra"> <select class="esmq-followup"><option value="false">End</option>'+
a+"</select> </div>").hide().fadeIn("fast")):5==e&&d.append($('<div class="esmq-options"> <div class="esmq-legends"> <span style="margin-left: 12px">Choice</span> <span style="margin-left: 115px">To question #</span> </div> <div class="esmq-option"> <div class="esmq-option-del"> <a href="#">-</a> </div> <div class="esmq-option-value"> <input type="text" placeholder="Option" class="input-field"> </div> <div class="esmq-option-followup"> <select class="esmq-followup"><option value="false">End</option>'+
a+'</select> </div> </div> <div class="esmq-option-add"> <a href="#">+</a> </div> </div>').hide().fadeIn("fast"))});$("#esm-questionnaire"+h).on("click",".esmq-add-question",function(b){b.preventDefault();b=$(this);var a;a=$(this).closest(".esmq-questions").find(".esmq-question").last().find(".esmq-question-id");a=0==a.length?1:parseInt(a.val())+1;var e=$(this).closest(".esm-questionnaire").find(".esmq-question-id").map(function(){return"<option value='"+this.value+"'>"+this.value+"</option>"}).get().join(""),
e='<div class="esmq-question"> <input type="hidden" value="'+a+'" class="esmq-question-id"> <div class="esmq-question-head"> <div class="esmq-question-head-left"> #'+a+'</div> <div class="esmq-question-head-right"> <a href="#">X</a> </div> </div> <div class="esmq-question-body"> <div class="esm-questionnaire-item option"> Title </div> <div class="esm-questionnaire-item value"> <input type="text" class="input-field esmq-question-title"> </div> <div class="esm-questionnaire-item option"> Type </div> <div class="esm-questionnaire-item value"> <select class="esmq-question-type"> <option value="1">Free text</option> <option value="2">Radio</option> <option value="3">Checkbox</option> <option value="4">Likert</option> <option value="5">Quick answer</option> </select> </div> <div class="esm-questionnaire-item option extra" style="display: block;">Follow up</div><div class="esm-questionnaire-item value extra" style="display: block;"> <select class="esmq-followup"><option value="false">End</option>'+
e+"</select> </div></div> </div>";$(this).closest(".esm-questionnaire").find(".esmq-followup").append($("<option/>",{value:a,text:a}));b.before($(e).fadeIn("fast"));$(this).closest(".esm-questionnaire").find("select.esmq-question-type").on("change",function(){var b=$(this).closest(".esmq-question").find(".esmq-question-id").val(),a=$(this).closest(".esm-questionnaire").find(".esmq-question-id").map(function(){if(this.value!=b)return"<option value='"+this.value+"'>"+this.value+"</option>"}).get().join(""),
e=$(this).val();$(this).parent().parent().children(".esmq-options");var d=$(this).parent().parent();d.children(".esmq-options").remove();d.children(".esm-questionnaire-item.extra").remove();1==e?d.append($('<div class="esm-questionnaire-item option extra">Follow up</div><div class="esm-questionnaire-item value extra"> <select class="esmq-followup"><option value="false">End</option>'+a+"</select> </div>").hide().fadeIn("fast")):2==e?d.append($('<div class="esmq-options"> <div class="esmq-legends"> <span style="margin-left: 12px">Choice</span> <span style="margin-left: 115px">To question #</span> </div> <div class="esmq-option"> <div class="esmq-option-del"> <a href="#">-</a> </div> <div class="esmq-option-value"> <input type="text" placeholder="Option" class="input-field"> </div> <div class="esmq-option-followup"> <select class="esmq-followup"><option value="false">End</option>'+
a+'</select> </div> </div> <div class="esmq-option-add"> <a href="#">+</a> </div> </div>').hide().fadeIn("fast")):3==e?(d.append($('<div class="esm-questionnaire-item option extra">Follow up</div><div class="esm-questionnaire-item value extra"> <select class="esmq-followup"><option value="false">End</option>'+a+"</select> </div>").hide().fadeIn("fast")),d.append($('<div class="esmq-options"> <div class="esmq-legends"> <span style="margin-left: 12px">Choice</span> </div> <div class="esmq-option"> <div class="esmq-option-del"> <a href="#">-</a> </div> <div class="esmq-option-value long"> <input type="text" placeholder="Option" class="input-field"> </div> </div> <div class="esmq-option-add"> <a href="#">+</a> </div> </div>').hide().fadeIn("fast"))):
4==e?d.append($('<div class="esm-questionnaire-item option extra"> Max label </div> <div class="esm-questionnaire-item value extra"> <input type="text" class="input-field likert-max-label"> </div> <div class="esm-questionnaire-item option extra"> Min label </div> <div class="esm-questionnaire-item value extra"> <input type="text" class="input-field likert-min-label"> </div><div class="esm-questionnaire-item option extra">Follow up</div><div class="esm-questionnaire-item value extra"> <select class="esmq-followup"><option value="false">End</option>'+
a+"</select> </div>").hide().fadeIn("fast")):5==e&&d.append($('<div class="esmq-options"> <div class="esmq-legends"> <span style="margin-left: 12px">Choice</span> <span style="margin-left: 115px">To question #</span> </div> <div class="esmq-option"> <div class="esmq-option-del"> <a href="#">-</a> </div> <div class="esmq-option-value"> <input type="text" placeholder="Option" class="input-field"> </div> <div class="esmq-option-followup"> <select class="esmq-followup"><option value="false">End</option>'+
a+'</select> </div> </div> <div class="esmq-option-add"> <a href="#">+</a> </div> </div>').hide().fadeIn("fast"))})});$("#esm-questionnaire"+h).on("click",".esmq-question-head-right",function(a){a.preventDefault();a=$(this).parent().parent().parent();var b=$(this).parent().parent(),e=b.find(".esmq-question-id").val();$(this).closest(".esm-questionnaire").find(".esmq-followup option[value='"+e+"']").remove();1<a.children(".esmq-question").length&&b.remove().fadeOut("fast")});h++}$("#tab_title");$("#tab_content");
var h=1,d=$("#esmq-questionnaires").tabs({disabled:[0]});$dlg=$(this).parent();$dlg.draggable({handle:".ui-tabs-nav"}).addClass("ui-draggable").find(".ui-dialog-titlebar").remove();$dlg.find(".ui-tabs").css("padding","0px");d.delegate("span.ui-icon-close","click",function(){var a=$(this).closest("li").remove().attr("aria-controls");$("#"+a).remove();d.tabs("refresh");1==$("#esmq-questionnaires ul li").length&&$("#esmq-questionnaires").append("<p class='esmq-info'>Add a new questionnaire by clicking 'Add new' -button</p>")});
d.bind("keyup",function(a){a.altKey&&a.keyCode===$.ui.keyCode.BACKSPACE&&(a=d.find(".ui-tabs-active").remove().attr("aria-controls"),$("#"+a).remove(),d.tabs("refresh"))});if(1<$("#questionnaires_plugin_esm_questionnaire").val().length)for(c in config=parseESMQConfig(),config)a(config[c]);$("#add-new").click(function(d){d.preventDefault();a('<div class="esm-questionnaire" id="esm-questionnaire{count}">\r\n\r\n    <div class="esm-questionnaire-item">\r\n      <div class="esm-questionnaire-item option">\r\n        <label>Start date</label>\r\n      </div>\r\n\r\n      <div class="esm-questionnaire-item value">\r\n        <input type="text" class="input-field esmq-startdate" id="esmq{count}-startdate">\r\n      </div>\r\n    </div>\r\n\r\n    <div class="esm-questionnaire-item">\r\n      <div class="esm-questionnaire-item option">\r\n        <label>End date</label>\r\n      </div>\r\n      \r\n      <div class="esm-questionnaire-item value">\r\n        <input type="text" class="input-field esmq-enddate" id="esmq{count}-enddate">\r\n      </div>\r\n    </div>\r\n\r\n    <div class="esm-questionnaire-item">\r\n      <div class="esm-questionnaire-item option">\r\n        Days\r\n      </div>\r\n      \r\n      <div class="esm-questionnaire-item value weekdays">\r\n        <div class="esmq-weekday">\r\n          <input type="checkbox" name="esmq-days-sun" class="esmq-days-sun" id="esmq{count}-day-sun">\r\n          <label for="esmq{count}-day-sun"></label>\r\n        </div>\r\n\r\n        <div class="esmq-weekday">\r\n          <input type="checkbox" name="esmq-days-mon" class="esmq-days-mon" id="esmq{count}-day-mon">\r\n          <label for="esmq{count}-day-mon"></label>\r\n        </div>\r\n\r\n        <div class="esmq-weekday">\r\n          <input type="checkbox" name="esmq-days-tue" class="esmq-days-tue" id="esmq{count}-day-tue">\r\n          <label for="esmq{count}-day-tue"></label>\r\n        </div>\r\n\r\n        <div class="esmq-weekday">\r\n          <input type="checkbox" name="esmq-days-wed" class="esmq-days-wed" id="esmq{count}-day-wed">\r\n          <label for="esmq{count}-day-wed"></label>\r\n        </div>\r\n\r\n        <div class="esmq-weekday">\r\n          <input type="checkbox" name="esmq-days-thu" class="esmq-days-thu" id="esmq{count}-day-thu">\r\n          <label for="esmq{count}-day-thu"></label>\r\n        </div>\r\n\r\n        <div class="esmq-weekday">\r\n          <input type="checkbox" name="esmq-days-fri" class="esmq-days-fri" id="esmq{count}-day-fri">\r\n          <label for="esmq{count}-day-fri"></label>\r\n        </div>\r\n\r\n        <div class="esmq-weekday">\r\n          <input type="checkbox" name="esmq-days-sat" class="esmq-days-sat" id="esmq{count}-day-sat">\r\n          <label for="esmq{count}-day-sat"></label>\r\n        </div>\r\n\r\n      </div>\r\n      \r\n    </div>\r\n\r\n    <div class="esm-questionnaire-item">\r\n      <div class="esm-questionnaire-item option">\r\n        <label>Start time</label>\r\n      </div>\r\n      \r\n      <div class="esm-questionnaire-item value">\r\n        <input type="text" id="esmq{count}-starttime" class="input-field esmq-starttime">\r\n      </div>\r\n    </div>\r\n\r\n    <div class="esm-questionnaire-item">\r\n      <div class="esm-questionnaire-item option">\r\n        <label>End time</label>\r\n      </div>\r\n      \r\n      <div class="esm-questionnaire-item value">\r\n        <input type="text" id="esmq{count}-endtime" class="input-field esmq-endtime">\r\n      </div>\r\n    </div>\r\n\r\n    <div class="esm-questionnaire-item" style="padding-bottom: 5px;">\r\n      <div class="esm-questionnaire-item option">\r\n        <label for="esmq{count}-amount">Amount</label>\r\n      </div>\r\n\r\n      <div class="esm-questionnaire-item value">\r\n        <input type="text" id="esmq{count}-amount" class="input-field esmq-amount">\r\n        \x3c!-- <div id="esmq{count}-amount" class="esmq-amount"></div> --\x3e\r\n      </div>\r\n    </div>\r\n\r\n    <div class="esm-questionnaire-item">\r\n      <div class="esm-questionnaire-item option">\r\n        <label for="esmq{count}-interval">Interval</label>\r\n      </div>\r\n      \r\n      <div class="esm-questionnaire-item value radio">\r\n          <input type="radio" name="esmq{count}-interval" id="esmq{count}-interval-spaced" class="esmq-interval" value="spaced" checked>\r\n          <label for="esmq{count}-interval-spaced">Spaced</label>\r\n          <input type="radio" name="esmq{count}-interval" id="esmq{count}-interval-random" class="esmq-interval" value="random">\r\n          <label for="esmq{count}-interval-random">Random</label>\r\n      </div>\r\n    </div>\r\n\r\n\r\n    <div class="esmq-questions">\r\n      \r\n      <div class="esmq-add-question">\r\n        <a href="#">Add a new question</a>\r\n      </div>\r\n\r\n    </div>\r\n\r\n</div>')})}})}
function parseESMQConfig(){for(var a=$("#questionnaires_plugin_esm_questionnaire").val(),a=JSON.parse(a),h=[],d=0;d<a.length;d++){var e="",b,m,p,q,r,l,f,k,n;b=a[d].id;m=new Date(1E3*a[d].general.startDate);m=m.getFullYear()+"-"+(m.getMonth()+1)+"-"+m.getDate();p=new Date(1E3*a[d].general.endDate);p=p.getFullYear()+"-"+(p.getMonth()+1)+"-"+p.getDate();q=a[d].general.startTime;r=a[d].general.endTime;n=a[d].general.weekDays;l=a[d].general.numberOfESM;f=a[d].general.interval;k=Math.floor(parseInt(q)%
86400/3600);k=1==k.toString().length?"0"+k:k;q=Math.floor(parseInt(q)%3600/60);q=1==q.toString().length?"0"+q:q;q=k+":"+q;k=Math.floor(parseInt(r)%86400/3600);k=1==k.toString().length?"0"+k:k;r=Math.floor(parseInt(r)%3600/60);r=1==r.toString().length?"0"+r:r;r=k+":"+r;e+='<div class="esm-questionnaire" id="esm-questionnaire'+b+'">';e+='<div class="esm-questionnaire-item"> <div class="esm-questionnaire-item option"> <label>Start date</label> </div> <div class="esm-questionnaire-item value"> <input type="text" class="input-field esmq-startdate" id="esmq'+
b+'-startdate" value="'+m+'"> </div> </div> <div class="esm-questionnaire-item"> <div class="esm-questionnaire-item option"> <label>End date</label> </div> <div class="esm-questionnaire-item value"> <input type="text" class="input-field esmq-enddate" id="esmq'+b+'-enddate" value="'+p+'"> </div> </div> <div class="esm-questionnaire-item"> <div class="esm-questionnaire-item option"> Days </div> <div class="esm-questionnaire-item value weekdays"> <div class="esmq-weekday"> <input type="checkbox" name="esmq-days-sun" class="esmq-days-sun" id="esmq'+
b+'-day-sun"'+(1==n[0]?" checked":"")+'> <label for="esmq'+b+'-day-sun"></label> </div> <div class="esmq-weekday"> <input type="checkbox" name="esmq-days-mon" class="esmq-days-mon" id="esmq'+b+'-day-mon"'+(1==n[1]?" checked":"")+'> <label for="esmq'+b+'-day-mon"></label> </div> <div class="esmq-weekday"> <input type="checkbox" name="esmq-days-tue" class="esmq-days-tue" id="esmq'+b+'-day-tue"'+(1==n[2]?" checked":"")+'> <label for="esmq'+b+'-day-tue"></label> </div> <div class="esmq-weekday"> <input type="checkbox" name="esmq-days-wed" class="esmq-days-wed" id="esmq'+
b+'-day-wed"'+(1==n[3]?" checked":"")+'> <label for="esmq'+b+'-day-wed"></label> </div> <div class="esmq-weekday"> <input type="checkbox" name="esmq-days-thu" class="esmq-days-thu" id="esmq'+b+'-day-thu"'+(1==n[4]?" checked":"")+'> <label for="esmq'+b+'-day-thu"></label> </div> <div class="esmq-weekday"> <input type="checkbox" name="esmq-days-fri" class="esmq-days-fri" id="esmq'+b+'-day-fri"'+(1==n[5]?" checked":"")+'> <label for="esmq'+b+'-day-fri"></label> </div> <div class="esmq-weekday"> <input type="checkbox" name="esmq-days-sat" class="esmq-days-sat" id="esmq'+
b+'-day-sat"'+(1==n[6]?" checked":"")+'> <label for="esmq'+b+'-day-sat"></label> </div> </div> </div> <div class="esm-questionnaire-item"> <div class="esm-questionnaire-item option"> <label>Start time</label> </div> <div class="esm-questionnaire-item value"> <input type="text" id="esmq'+b+'-starttime" class="input-field esmq-starttime" value="'+q+'"> </div> </div> <div class="esm-questionnaire-item"> <div class="esm-questionnaire-item option"> <label>End time</label> </div> <div class="esm-questionnaire-item value"> <input type="text" id="esmq'+
b+'-endtime" class="input-field esmq-endtime" value="'+r+'"> </div> </div> <div class="esm-questionnaire-item" style="padding-bottom: 5px;"> <div class="esm-questionnaire-item option"> <label for="esmq'+b+'-amount">Amount</label> </div> <div class="esm-questionnaire-item value"> <input type="text" id="esmq'+b+'-amount" class="input-field esmq-amount" value="'+l+'"> </div> </div> <div class="esm-questionnaire-item"> <div class="esm-questionnaire-item option"> <label for="esmq'+b+'-interval">Interval</label> </div> <div class="esm-questionnaire-item value radio"> <input type="radio" name="esmq'+
b+'-interval" id="esmq'+b+'-interval-spaced" class="esmq-interval" value="spaced"'+("spaced"==f?" checked":"")+'> <label for="esmq'+b+'-interval-spaced">Spaced</label> <input type="radio" name="esmq'+b+'-interval" id="esmq'+b+'-interval-random" class="esmq-interval" value="random"'+("random"==f?" checked":"")+'> <label for="esmq'+b+'-interval-random">Random</label> </div> </div> <div class="esmq-questions">';for(b=0;b<a[d].questions.length;b++){m=a[d].questions[b].id;p=a[d].questions[b].data.esm.esm[0].esm_title;
l=a[d].questions[b].data.esm.esm[0].esm_type;n="<option value='false'>End</option>";for(f=1;f<a[d].questions.length+1;f++)f!=m&&(n+="<option value='"+f+"'>"+f+"</option>");var g;if(1==l)g='<div class="esm-questionnaire-item option extra">Follow up</div><div class="esm-questionnaire-item value extra"> <select class="esmq-followup"><option value="false">End</option>'+n+"</select> </div>";else if(2==l){g="";for(var s in a[d].questions[b].data.conditions){g+='<div class="esmq-option"><div class="esmq-option-del"><a href="#">-</a></div><div class="esmq-option-value"><input type="text" placeholder="Option" class="input-field" value="'+
s+'"></div><div class="esmq-option-followup"><select class="esmq-followup" type="hidden"><option value="false">End</option>';for(f=1;f<a[d].questions.length+1;f++)f!=m&&(g+="<option value='"+f+"'"+(a[d].questions[b].data.conditions[s]==f?" selected":"")+">"+f+"</option>");g+="</select></div></div>"}g='<div class="esmq-options"> <div class="esmq-legends"> <span style="margin-left: 12px">Choice</span> <span style="margin-left: 115px">To question #</span> </div>'+g+'<div class="esmq-option-add"> <a href="#">+</a> </div> </div>'}else if(3==
l){for(s in a[d].questions[b].data.conditions);g='<div class="esm-questionnaire-item option extra">Follow up</div><div class="esm-questionnaire-item value extra"> <select class="esmq-followup"><option value="false">End</option>'+n+"</select> </div>";g+='<div class="esmq-options"> <div class="esmq-legends"> <span style="margin-left: 12px">Choice</span> </div> <div class="esmq-option"> <div class="esmq-option-del"> <a href="#">-</a> </div> <div class="esmq-option-value long"> <input type="text" placeholder="Option" class="input-field"> </div> </div> <div class="esmq-option-add"> <a href="#">+</a> </div> </div>'}else if(4==
l)g='<div class="esm-questionnaire-item option extra"> Max label </div> <div class="esm-questionnaire-item value extra"> <input type="text" class="input-field likert-max-label"> </div> <div class="esm-questionnaire-item option extra"> Min label </div> <div class="esm-questionnaire-item value extra"> <input type="text" class="input-field likert-min-label"> </div><div class="esm-questionnaire-item option extra">Follow up</div><div class="esm-questionnaire-item value extra"> <select class="esmq-followup"><option value="false">End</option>'+
n+"</select> </div>";else if(5==l){g="";for(s in a[d].questions[b].data.conditions){g+='<div class="esmq-option"><div class="esmq-option-del"><a href="#">-</a></div><div class="esmq-option-value"><input type="text" placeholder="Option" class="input-field" value="'+s+'"></div><div class="esmq-option-followup"><select class="esmq-followup" type="hidden"><option value="false">End</option>';for(f=1;f<a[d].questions.length+1;f++)f!=m&&(g+="<option value='"+f+"'"+(a[d].questions[b].data.conditions[s]==
f?" selected":"")+">"+f+"</option>");g+="</select></div></div>"}g='<div class="esmq-options"> <div class="esmq-legends"> <span style="margin-left: 12px">Choice</span> <span style="margin-left: 115px">To question #</span> </div>'+g+' <div class="esmq-option-add"> <a href="#">+</a> </div> </div>'}e+='<div class="esmq-question" style="display: block;"> <input type="hidden" value="'+m+'" class="esmq-question-id"> <div class="esmq-question-head"> <div class="esmq-question-head-left">#'+m+'</div> <div class="esmq-question-head-right"> <a href="#">X</a> </div> </div> <div class="esmq-question-body"> <div class="esm-questionnaire-item option">Title</div> <div class="esm-questionnaire-item value"> <input type="text" class="input-field esmq-question-title" value='+
p+'> </div> <div class="esm-questionnaire-item option"> Type </div> <div class="esm-questionnaire-item value"> <select class="esmq-question-type"> <option value="1"'+(1==l?" selected":"")+'>Free text</option> <option value="2"'+(2==l?" selected":"")+'>Radio</option> <option value="3"'+(3==l?" selected":"")+'>Checkbox</option> <option value="4"'+(4==l?" selected":"")+'>Likert</option> <option value="5"'+(5==l?" selected":"")+">Quick answer</option> </select> </div> "+g+" </div> </div>"}e+='<div class="esmq-add-question"> <a href="#">Add a new question</a> </div> </div> </div>';
h.push(e)}return h}
function getESMQConfig(a){var h=[];a=a.find(".esm-questionnaire");for(var d=0;d<a.length;d++){var e,b,m,p,q=[],r={id:$(a[d]).attr("id").split("-questionnaire")[1]};e=new Date($(a[d]).find(".esmq-startdate").val());b=new Date($(a[d]).find(".esmq-enddate").val());startTime=$(a[d]).find(".esmq-starttime").val().split(":");startTime=3600*startTime[0]+60*startTime[1];m=$(a[d]).find(".esmq-endtime").val().split(":");m=3600*m[0]+60*m[1];numberOfESM=$(a[d]).find(".esmq-amount").val();p=$(a[d]).find("input.esmq-interval").filter(":checked").val();
for(var l=$(a[d]).find(".esmq-weekday input"),f=0;7>f;f++)q.push($(l[f]).prop("checked"));var k,l=e.getDay()-1;r.general={startDate:e.getTime()/1E3,endDate:b.getTime()/1E3,startTime:startTime,endTime:m,weekDays:q,numberOfESM:numberOfESM,interval:p};e.setTime(e.getTime()+6E4*e.getTimezoneOffset());for(var f={operand:"AND",triggers:[]},n=e.getTime()/1E3;n<=b.getTime()/1E3;n+=86400)if(l=(l+1)%7,q[l])if("spaced"==p){e=(m-startTime)/numberOfESM;for(var g=1;g<=numberOfESM;g++)k=n+startTime+e*(g-1),f.triggers.push({type:"alarm",
data:{timestamp:1E3*k}})}else if("random"==p)for(g=1;g<=numberOfESM;g++)e=Math.floor(Math.random()*(m-startTime)+1),k=n+startTime+e,f.triggers.push({type:"alarm",data:{timestamp:1E3*k}});r.trigger=f;b=$(a[d]).find(".esmq-question");m=[];for(p=0;p<b.length;p++){q=parseInt($(b[p]).find(".esmq-question-head-left").last().text().trim().split("#")[1]);l=$(b[p]).find(".esmq-question-title").val();k=$(b[p]).find(".esmq-option");f={};e=[];for(var s=0;s<k.length;s++)n=$(k[s]).find(".esmq-option-value input").val(),
g=$(k[s]).find(".esmq-followup").children("option").filter(":selected").val(),f[n]=g,e.push(n);var t;k=$(b[p]).find(".esmq-question-type").val();1==k?t={esm_type:"1",esm_title:l,esm_instructions:"",esm_submit:"Submit",esm_expiration_threashold:"0",esm_trigger:"esm-questionnaire"}:2==k?t={esm_type:"2",esm_title:l,esm_instructions:"",esm_radios:e,esm_submit:"Submit",esm_expiration_threashold:"0",esm_trigger:"esm-questionnaire"}:3==k?t={esm_type:"3",esm_title:l,esm_instructions:"",esm_checkboxes:e,esm_submit:"Submit",
esm_expiration_threashold:"0",esm_trigger:"esm-questionnaire"}:4==k?(t=$(b[p]).find(".likert-max-label").val(),e=$(b[p]).find(".likert-min-label").val(),t={esm_type:"4",esm_title:l,esm_instructions:"",esm_likert_max:"5",esm_likert_max_label:t,esm_likert_min_label:e,esm_likert_step:"1",esm_submit:"Submit",esm_expiration_threashold:"0",esm_trigger:"esm-questionnaire"}):5==k&&(t={esm_type:"5",esm_title:l,esm_instructions:"",esm_quick_answers:e,esm_expiration_threashold:"0",esm_trigger:"esm-questionnaire"});
m.push({id:q,type:"esm",data:{esm:{esm:Array(t)},conditions:f}})}r.questions=m;h.push(r)}return JSON.stringify(h)};
